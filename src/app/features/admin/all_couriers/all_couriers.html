<div class="couriers-layout">

  <!-- â‘  OVERLAY â€” en dehors de tout -->
  <div class="overlay" [class.open]="sidebarOpen()" (click)="closeSidebar()"></div>

  <!-- â‘¡ SIDEBAR â€” en dehors du topbar, directement dans couriers-layout -->
  <aside class="sidebar" [class.open]="sidebarOpen()">
    <div class="sidebar-header">
      <div class="sidebar-avatar">{{ getInitialsUser() }}</div>
      <div>
        <p class="sidebar-name">{{ user()?.prenom }} {{ user()?.nom }}</p>
        <p class="sidebar-email">{{ user()?.email }}</p>
      </div>
    </div>

    <nav class="sidebar-nav">
      <button class="nav-item" (click)="goToProfile()">
        Mon Profil
      </button>
      <button class="nav-item active" (click)="goToCouriers()">
         Couriers
      </button>
      <!-- Merchants est actif sur cette page -->
      <button class="nav-item" (click)="goToMerchants()">
        Merchants
      </button>
      <button class="nav-item" (click)="goToSettings()">
        ParamÃ¨tres
      </button>
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn" (click)="logout()">
        {{ t('seDeconnecter') }}
      </button>
    </div>
  </aside>

  <!-- â‘¢ MAIN â€” tout le contenu visible -->
  <div class="main-content">

    <!-- Topbar (SANS sidebar dedans) -->
    <header class="topbar">
      <div class="topbar-left">
        <!-- Bouton â˜° qui ouvre la sidebar -->
        <button class="menu-btn" (click)="toggleSidebar()">
          <span></span><span></span><span></span>
        </button>
        <div class="brand">
          <img src="assets/images/logo.jpg" alt="Tawsila" class="brand-logo">
          <span>Tawsila</span>
        </div>
      </div>
      <div class="topbar-right">
        <span class="admin-chip"> Admin</span>
       
      </div>
    </header>

    <!-- Toast -->
    <div class="toast"
      *ngIf="toastMsg()"
      [class.toast--success]="toastType() === 'success'"
      [class.toast--error]="toastType() === 'error'">
      {{ toastMsg() }}
    </div>

    <!-- Contenu principal -->
    <main class="content">

      <div class="page-header">
        <div>
          <h1>ðŸš´ Couriers Management</h1>
          <p>Review courier applications and grant or deny access</p>
        </div>
        <button class="btn-refresh" (click)="loadCoursiers()" [disabled]="loading()">
          ðŸ”„ 
        </button>
      </div>

      <!-- Stats -->
      <div class="stats-row" *ngIf="!loading() && coursiers().length > 0">
        <div class="stat-card">
          <span class="stat-num">{{ coursiers().length }}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-card stat--pending">
          <span class="stat-num">{{ pendingCount() }}</span>
          <span class="stat-label"> Pending</span>
        </div>
        <div class="stat-card stat--validated">
          <span class="stat-num">{{ validatedCount() }}</span>
          <span class="stat-label"> Validated</span>
        </div>
        <div class="stat-card stat--refused">
          <span class="stat-num">{{ refusedCount() }}</span>
          <span class="stat-label">Refused</span>
        </div>
      </div>

      <!-- Filtres -->
      <div class="filter-tabs">
        <button [class.active]="filter() === 'ALL'"        (click)="filter.set('ALL')">
          All <span class="tab-badge">{{ coursiers().length }}</span>
        </button>
        <button [class.active]="filter() === 'EN_ATTENTE'" (click)="filter.set('EN_ATTENTE')">
           Pending
          <span class="tab-badge tab-badge--pending" *ngIf="pendingCount() > 0">{{ pendingCount() }}</span>
        </button>
        <button [class.active]="filter() === 'VALIDE'"     (click)="filter.set('VALIDE')">
           Validated <span class="tab-badge">{{ validatedCount() }}</span>
        </button>
        <button [class.active]="filter() === 'REFUSE'"     (click)="filter.set('REFUSE')">
          Refused <span class="tab-badge">{{ refusedCount() }}</span>
        </button>
      </div>

      <!-- Loading -->
      <div class="loading-box" *ngIf="loading()">
        <div class="spinner"></div>
        <p>Loading couriers...</p>
      </div>

      <!-- Empty -->
      <div class="empty-box" *ngIf="!loading() && filteredCoursiers().length === 0">
        <span>ðŸš´</span>
        <p>No couriers in this category</p>
      </div>

      <!-- Cards -->
      <div class="cards-grid" *ngIf="!loading() && filteredCoursiers().length > 0">
        <div class="courier-card"
             *ngFor="let c of filteredCoursiers()"
             [class.card--pending]="c.statut === 'EN_ATTENTE'"
             [class.card--validated]="c.statut === 'VALIDE'"
             [class.card--refused]="c.statut === 'REFUSE'">

          <div class="card-head">
            <div class="avatar">
              <img *ngIf="c.imageUrl"
                [src]="'http://localhost:8082' + c.imageUrl"
                alt="Photo" class="avatar-img">
              <span *ngIf="!c.imageUrl" class="avatar-initials">{{ getInitials(c) }}</span>
            </div>
            <div class="courier-name">
              <h3>{{ c.prenom }} {{ c.nom }}</h3>
              <p>{{ c.email }}</p>
            </div>
            <div class="statut-badge"
              [style.color]="getStatutBadge(c.statut).color"
              [style.background]="getStatutBadge(c.statut).bg"
              [style.border]="'1px solid ' + getStatutBadge(c.statut).border">
              {{ getStatutBadge(c.statut).label }}
            </div>
          </div>

          <div class="info-grid">
            <div class="info-cell">
              <span class="info-label"> Phone</span>
              <span class="info-val">{{ c.telephone || 'â€”' }}</span>
            </div>
            <div class="info-cell">
              <span class="info-label"> Vehicle</span>
              <span class="info-val">{{ c.vehiculeType || 'â€”' }}</span>
            </div>
            <div class="info-cell">
              <span class="info-label"> Zone</span>
              <span class="info-val">{{ c.zoneLivraison || 'â€”' }}</span>
            </div>
            <div class="info-cell">
              <span class="info-label">Plate</span>
              <span class="info-val">{{ c.immatriculation || 'â€”' }}</span>
            </div>
            <div class="info-cell">
              <span class="info-label"> City</span>
              <span class="info-val">{{ c.city || 'â€”' }}</span>
            </div>
            <div class="info-cell">
              <span class="info-label"> Availability</span>
              <span class="info-val">{{ c.disponibilite || 'â€”' }}</span>
            </div>
          </div>

          <div class="card-actions">

            <!-- EN_ATTENTE -->
            <ng-container *ngIf="c.statut === 'EN_ATTENTE'">
              <div class="access-status pending-status">
                 Awaiting admin decision
              </div>
              <div class="btn-group">
                <button class="btn-accept"
                  [disabled]="actionLoading() !== null"
                  (click)="valider(c.id)">
                  <span class="btn-spinner" *ngIf="actionLoading() === c.id"></span>
                  <span *ngIf="actionLoading() !== c.id">Accept</span>
                </button>
                <button class="btn-refuse"
                  [disabled]="actionLoading() !== null"
                  (click)="refuser(c.id)">
                  <span class="btn-spinner" *ngIf="actionLoading() === c.id"></span>
                  <span *ngIf="actionLoading() !== c.id">Refuse</span>
                </button>
              </div>
            </ng-container>

            <!-- VALIDE -->
            <ng-container *ngIf="c.statut === 'VALIDE'">
              <div class="access-status granted-status">
                ðŸ”“ Access granted â€” can login
              </div>
              <div class="btn-group">
                <button class="btn-refuse"
                  [disabled]="actionLoading() !== null"
                  (click)="refuser(c.id)">
                  <span class="btn-spinner" *ngIf="actionLoading() === c.id"></span>
                  <span *ngIf="actionLoading() !== c.id">ðŸš« Suspend access</span>
                </button>
              </div>
            </ng-container>

            <!-- REFUSE -->
            <ng-container *ngIf="c.statut === 'REFUSE'">
              <div class="access-status denied-status">
                ðŸ”’ Access denied â€” cannot login
              </div>
              <div class="btn-group">
                <button class="btn-accept"
                  [disabled]="actionLoading() !== null"
                  (click)="valider(c.id)">
                  <span class="btn-spinner" *ngIf="actionLoading() === c.id"></span>
                  <span *ngIf="actionLoading() !== c.id">âœ… Reactivate</span>
                </button>
              </div>
            </ng-container>

          </div>
        </div>
      </div>

    </main>
  </div>

</div>